# Trace Point - Backend

API RESTful para organiza√ß√£o de visitas durante a COP-30 em Bel√©m. Permite o registro de **usu√°rios** (admin, visitor, organizer), **eventos**, **locais visitados** e **agendamentos**.

---

## Tecnologias

* Node.js 18
* TypeScript
* PostgreSQL
* TypeORM
* Docker + Docker Compose
* pgAdmin (interface de banco)

---

## Requisitos

Para rodar com Docker:

* Docker
* Docker Compose

Para rodar manualmente:

* Node.js 18+
* PostgreSQL
* NPM

---

## Instala√ß√£o

### 1. Clone o reposit√≥rio

```bash
git clone https://github.com/vyctor-carvalho/Trace_Point.git
cd Trace_Point
```

---

## Rodando com Docker

### 2. Copie o arquivo `.env`

```bash
cp .env.copy .env
```

Edite as vari√°veis conforme necess√°rio. Para uso com Docker, mantenha:

```ini
DB_HOST=db
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=postgres
DB_NAME=tracepoint
```

### 3. Suba os containers

```bash
docker-compose up --build
```

### 4. Acessar o banco de dados via pgAdmin

Abra o **pgAdmin** em: `http://localhost:8080`

Na interface do pgAdmin, adicione uma nova conex√£o com os seguintes dados:

* **Name**: `tracepoint-db` (ou qualquer nome)
* **Host name/address**: `db`
* **Port**: `5432`
* **Username**: `postgres`
* **Password**: `postgres`

Ap√≥s conectar, selecione o banco de dados `tracepoint` no painel lateral para visualizar tabelas, dados e executar queries.

## Rodando Manualmente

### 1. Instale as depend√™ncias

```bash
npm install
```

### 2. Configure o `.env` com seu PostgreSQL local

```ini
# Configura√ß√µes do servidor
SYSTEM_API_PORT=sua_porta_pra_api

# Dados do banco
DB_HOST=db
DB_USER=postgres
DB_PORT=sua_porta
DB_PASSWORD=postgres
DB_NAME=nome_do_banco

# JWT
JWT_SECRET=sua_chave_secreta
REFRESH_SECRET=sua_chave
JWT_EXPIRES_IN=3600
REFRSH_TOKEN_EXPIRES_IN=604800
```

### 3. Rode as migrations

```bash
npm run migration:run
```

### 4. Inicie o servidor

```bash
npm run dev
```

---

## N√≠veis de Acesso

A API utiliza tr√™s n√≠veis de acesso para proteger suas rotas:

* **Visitor**: Usu√°rio autenticado com permiss√µes b√°sicas, como visualizar eventos, locais e agendar visitas.
* **Organizer**: Usu√°rio autenticado com permiss√µes de Visitor, al√©m da capacidade de criar e gerenciar eventos e locais que criou.
* **Admin**: Usu√°rio autenticado com acesso total a todas as funcionalidades da API, incluindo gerenciamento de usu√°rios.
* **P√∫blico**: Rotas que n√£o exigem autentica√ß√£o.

As rotas protegidas por JWT exigem um token de acesso v√°lido no cabe√ßalho `Authorization` (ex: `Bearer seu_token_jwt`).

---

## Cria√ß√£o de Usu√°rios

### Admin (somante via SQL):

```sql
INSERT INTO "user" (
  id, name, profile_pick, role, email, password
) VALUES (
  '9dfce170-5094-436f-9413-f5afc769a75e',
  'Admin User',
  '[https://example.com/avatar.png](https://example.com/avatar.png)',
  'admin',
  'admin@example.com',
  '$2b$10$yG9D2ihkLL6hTh5KCw/l5.BqAqJ3i49GIvksxCBStGSMEJtTHS2ey' -- Senha: admin123
);
```

### Visitor ou Organizer (POST `/user/register`):

Endpoint p√∫blico para registro de novos usu√°rios.
```json
{
  "name": "Nome do usu√°rio",
  "userLogin": {
    "email": "email@example.com",
    "password": "senha123"
  },
  "profilePick": "https://example.com/foto.jpg",
  "role": "visitor" // ou "organizer"
}
```

---

## Rotas da API

### Autentica√ß√£o (`/auth`)

| M√©todo | Rota             | Prote√ß√£o JWT | N√≠vel de Acesso | Descri√ß√£o                     |
| :----- | :--------------- | :----------- | :-------------- | :------------------------------ |
| `POST` | `/auth/login`    | N√£o          | P√∫blico         | Realiza o login do usu√°rio.     |
| `POST` | `/auth/refresh`  | N√£o          | P√∫blico         | Atualiza o token de acesso.   |

### Usu√°rios (`/user`)

| M√©todo | Rota                | Prote√ß√£o JWT | N√≠vel de Acesso        | Descri√ß√£o                                                                |
| :----- | :------------------ | :----------- | :--------------------- | :----------------------------------------------------------------------- |
| `POST` | `/user/register`    | N√£o          | P√∫blico                | Registra um novo usu√°rio (visitor ou organizer).                          |
| `POST` | `/user/booking`     | Sim          | Visitor, Organizer, Admin | Agenda uma visita a um evento para um usu√°rio.                             |
| `GET`  | `/user/`            | Sim          | Admin                  | Lista todos os usu√°rios.                                                 |
| `GET`  | `/user/:id`         | Sim          | Admin                  | Busca um usu√°rio espec√≠fico pelo ID.                                      |
| `PUT`  | `/user/:id`         | Sim          | Visitor, Organizer, Admin | Atualiza dados de um usu√°rio (usu√°rio atualiza o pr√≥prio, admin qualquer). |
| `DELETE`| `/user/:id`        | Sim          | Admin                  | Deleta um usu√°rio espec√≠fico pelo ID.                                     |

### Locais (`/place`)

| M√©todo | Rota             | Prote√ß√£o JWT | N√≠vel de Acesso        | Descri√ß√£o                               |
| :----- | :--------------- | :----------- | :--------------------- | :---------------------------------------- |
| `POST` | `/place/`        | Sim          | Organizer, Admin       | Cria um novo local.                       |
| `GET`  | `/place/`        | Sim          | Visitor, Organizer, Admin | Lista todos os locais.                    |
| `GET`  | `/place/:id`     | Sim          | Visitor, Organizer, Admin | Busca um local espec√≠fico pelo ID.        |
| `PUT`  | `/place/:id`     | Sim          | Organizer, Admin       | Atualiza um local espec√≠fico pelo ID.   |
| `DELETE`| `/place/:id`    | Sim          | Admin                  | Deleta um local espec√≠fico pelo ID.     |

### Eventos (`/event`)

| M√©todo | Rota             | Prote√ß√£o JWT | N√≠vel de Acesso        | Descri√ß√£o                               |
| :----- | :--------------- | :----------- | :--------------------- | :---------------------------------------- |
| `POST` | `/event/`        | Sim          | Organizer, Admin       | Cria um novo evento.                      |
| `GET`  | `/event/`        | Sim          | Visitor, Organizer, Admin | Lista todos os eventos.                   |
| `GET`  | `/event/:id`     | Sim          | Visitor, Organizer, Admin | Busca um evento espec√≠fico pelo ID.       |
| `PUT`  | `/event/:id`     | Sim          | Organizer, Admin       | Atualiza um evento espec√≠fico pelo ID.  |
| `DELETE`| `/event/:id`    | Sim          | Organizer, Admin       | Deleta um evento espec√≠fico pelo ID.    |

### Visitas Realizadas (`/visited`)

| M√©todo | Rota                     | Prote√ß√£o JWT | N√≠vel de Acesso        | Descri√ß√£o                                                               |
| :----- | :----------------------- | :----------- | :--------------------- | :---------------------------------------------------------------------- |
| `POST` | `/visited/`              | Sim          | Visitor, Organizer, Admin | Registra uma visita a um local.                                          |
| `GET`  | `/visited/`              | Sim          | Visitor, Organizer, Admin | Lista todos os registros de visitas (admins veem todos, outros os seus). |
| `GET`  | `/visited/user/:userId`  | Sim          | Visitor, Organizer, Admin | Lista visitas por ID de usu√°rio (usu√°rio v√™ o seu, admin/organizer mais). |
| `GET`  | `/visited/place/:placeId`| Sim          | Visitor, Organizer, Admin | Lista visitas por ID de local.                                           |
| `PUT`  | `/visited/`              | Sim          | Visitor, Organizer, Admin | Atualiza um registro de visita.                                          |
| `DELETE`| `/visited/`             | Sim          | Organizer, Admin       | Deleta um registro de visita (identificado via body: userId, placeId).   |

---

## Exemplos de Requisi√ß√µes (Corpo)

### Criar local (`POST /place`)
*Acesso: Organizer, Admin*
```json
{
  "name": "Esta√ß√£o das Docas",
  "type": "cultural",
  "address": {
    "postalColde": "66010-020",
    "street": "Av. Boulevard Castilhos Fran√ßa",
    "numberHouse": 600,
    "complement": "Armaz√©m 2"
  }
}
```

### Criar evento (`POST /event`)
*Acesso: Organizer, Admin*
```json
{
  "title": "Tour COP-30",
  "eventDate": "2025-07-15T14:00:00.000Z",
  "description": "Tour pelo centro hist√≥rico de Bel√©m.",
  "place": "UUID-do-place"
}
```

### Agendar visita (`POST /user/booking`)
*Acesso: Visitor, Organizer, Admin*
```json
{
  "eventId": "UUID-event",
  "userId": "UUID-user"
}
```

### Marcar visita como feita (`POST /visited`)
*Acesso: Visitor, Organizer, Admin*
```json
{
  "userId": "UUID-user",
  "placeId": "UUID-place",
  "visitDate": "2025-05-24T10:30:00.000Z"
}
```

---

## Estrutura do Projeto

```
üìÅ raiz/
‚îÇ
‚îú‚îÄ‚îÄ .env               # Vari√°veis reais
‚îú‚îÄ‚îÄ .env.copy          # Modelo para configura√ß√£o
‚îú‚îÄ‚îÄ .dockerignore      # Ignora arquivos do Docker
‚îú‚îÄ‚îÄ docker-compose.yml # Arquitetura dos containers
‚îú‚îÄ‚îÄ Dockerfile         # Imagem do app
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ tsconfig.json
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ index.ts
‚îú‚îÄ‚îÄ server.ts
‚îÇ
‚îî‚îÄ‚îÄ src/
    ‚îÇ
    ‚îú‚îÄ‚îÄ config/
    ‚îÇ   ‚îî‚îÄ‚îÄ EsportEnv.ts
    ‚îÇ
    ‚îú‚îÄ‚îÄ controllers/
    ‚îÇ   ‚îú‚îÄ‚îÄ AuthController.ts
    ‚îÇ   ‚îú‚îÄ‚îÄ EventController.ts
    ‚îÇ   ‚îú‚îÄ‚îÄ PlaceController.ts
    ‚îÇ   ‚îú‚îÄ‚îÄ UserController.ts
    ‚îÇ   ‚îî‚îÄ‚îÄ VisitedController.ts
    ‚îÇ
    ‚îú‚îÄ‚îÄ DTO/
    ‚îÇ   ‚îú‚îÄ‚îÄ wrappers/
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AddressDTO.ts
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ LoginInfoDTO.ts
    ‚îÇ   ‚îú‚îÄ‚îÄ BookingDTO.ts
    ‚îÇ   ‚îú‚îÄ‚îÄ EventDTO.ts
    ‚îÇ   ‚îú‚îÄ‚îÄ PlaceDTO.ts
    ‚îÇ   ‚îú‚îÄ‚îÄ UserDTO.ts
    ‚îÇ   ‚îî‚îÄ‚îÄ VisitedDTO.ts
    ‚îÇ
    ‚îú‚îÄ‚îÄ error/
    ‚îÇ   ‚îú‚îÄ‚îÄ ErrorsHandler.ts
    ‚îÇ   ‚îî‚îÄ‚îÄ HttpException.ts
    ‚îÇ
    ‚îú‚îÄ‚îÄ middleware/
    ‚îÇ   ‚îú‚îÄ‚îÄ ErrorsHandler.ts
    ‚îÇ   ‚îú‚îÄ‚îÄ JwtRequired.ts
    ‚îÇ   ‚îú‚îÄ‚îÄ RoleCheck.ts
    ‚îÇ   ‚îî‚îÄ‚îÄ ValidateId.ts
    ‚îÇ
    ‚îú‚îÄ‚îÄ migrations/
    ‚îÇ   ‚îú‚îÄ‚îÄ 1747755304546-GeneratedMigration.ts
    ‚îÇ   ‚îî‚îÄ‚îÄ 1747865261580-GeneratedMigration.ts
    ‚îÇ
    ‚îú‚îÄ‚îÄ models/
    ‚îÇ   ‚îú‚îÄ‚îÄ enum/
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PlaceType.ts
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ UserRole.ts
    ‚îÇ   ‚îú‚îÄ‚îÄ wrappers/
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Address.ts
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ LoginInfo.ts
    ‚îÇ   ‚îú‚îÄ‚îÄ Event.ts
    ‚îÇ   ‚îú‚îÄ‚îÄ Place.ts
    ‚îÇ   ‚îú‚îÄ‚îÄ User.ts
    ‚îÇ   ‚îî‚îÄ‚îÄ VisitedPlaces.ts
    ‚îÇ
    ‚îú‚îÄ‚îÄ repositories/
    ‚îÇ   ‚îú‚îÄ‚îÄ EventRepository.ts
    ‚îÇ   ‚îú‚îÄ‚îÄ PlaceRepository.ts
    ‚îÇ   ‚îú‚îÄ‚îÄ UserRepository.ts
    ‚îÇ   ‚îî‚îÄ‚îÄ VisitedRepository.ts
    ‚îÇ
    ‚îú‚îÄ‚îÄ routes/
    ‚îÇ   ‚îú‚îÄ‚îÄ AuthRoutes.ts
    ‚îÇ   ‚îú‚îÄ‚îÄ EventRoutes.ts
    ‚îÇ   ‚îú‚îÄ‚îÄ PlaceRoutes.ts
    ‚îÇ   ‚îú‚îÄ‚îÄ UserRoutes.ts
    ‚îÇ   ‚îî‚îÄ‚îÄ VisitedRoutes.ts
    ‚îÇ
    ‚îú‚îÄ‚îÄ service/
    ‚îÇ   ‚îú‚îÄ‚îÄ AuthService.ts
    ‚îÇ   ‚îú‚îÄ‚îÄ EventService.ts
    ‚îÇ   ‚îú‚îÄ‚îÄ PlaceService.ts
    ‚îÇ   ‚îú‚îÄ‚îÄ UserService.ts
    ‚îÇ   ‚îî‚îÄ‚îÄ VisitedService.ts
    ‚îÇ
    ‚îú‚îÄ‚îÄ utils/
    ‚îÇ   ‚îú‚îÄ‚îÄ ExistsValidator.ts
    ‚îÇ   ‚îú‚îÄ‚îÄ TokenManager.ts
    ‚îÇ   ‚îî‚îÄ‚îÄ ValidateRequestBody.ts
    ‚îÇ
    ‚îú‚îÄ‚îÄ db_config/
    ‚îÇ   ‚îî‚îÄ‚îÄ AppDataSource.ts
    ‚îÇ
    ‚îî‚îÄ‚îÄ @types/
        ‚îî‚îÄ‚îÄ express
            ‚îî‚îÄ‚îÄ index.d.ts
```
